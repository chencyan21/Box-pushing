<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·³ä¸€è·³æ¸¸æˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        
        h1 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .game-area {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        #gameCanvas {
            border: 2px solid #34495e;
            border-radius: 8px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 100%);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        #powerInput {
            width: 100px;
            padding: 8px;
            border: none;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
        }
        
        #apiKeyInput {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
        }
        
        button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .game-over {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® è·³ä¸€è·³æ¸¸æˆ</h1>
        
        <div class="game-area">
            <canvas id="gameCanvas" width="800" height="400"></canvas>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="powerInput">è·³è·ƒåŠ›åº¦ (0-100):</label>
                <input type="number" id="powerInput" min="0" max="100" value="50">
            </div>
            <div class="control-group">
                <label for="apiKeyInput">Gemini API Key:</label>
                <input type="password" id="apiKeyInput" placeholder="è¾“å…¥æ‚¨çš„API Key" style="width: 200px;">
            </div>
            <button id="jumpBtn">ğŸš€ è·³è·ƒ</button>
            <button id="aiJumpBtn" disabled>ğŸ¤– AIè‡ªåŠ¨è·³è·ƒ</button>
            <button id="resetBtn">ğŸ”„ é‡ç½®æ¸¸æˆ</button>
        </div>
        
        <div class="status">
            <div class="score">å¾—åˆ†: <span id="score">0</span></div>
            <div class="status-grid">
                <div class="status-item">
                    <strong>ç©å®¶ä½ç½®:</strong> <span id="playerPos">(100, 300)</span>
                </div>
                <div class="status-item">
                    <strong>ç›®æ ‡å¹³å°:</strong> <span id="platformInfo">(200, 300, 300)</span>
                </div>
                <div class="status-item">
                    <strong>æ¨ªå‘é€Ÿåº¦å€ç‡:</strong> <span id="vxMul">0.15</span>
                </div>
                <div class="status-item">
                    <strong>çºµå‘é€Ÿåº¦å€ç‡:</strong> <span id="vyMul">-0.25</span>
                </div>
                <div class="status-item">
                    <strong>é‡åŠ›åŠ é€Ÿåº¦:</strong> <span id="gravity">0.5</span>
                </div>
                <div class="status-item">
                    <strong>æ¸¸æˆçŠ¶æ€:</strong> <span id="gameStatus">å‡†å¤‡è·³è·ƒ</span>
                </div>
                <div class="status-item">
                    <strong>AIçŠ¶æ€:</strong> <span id="aiStatus">æœªå¯ç”¨</span>
                </div>
                <div class="status-item">
                    <strong>AIæ¨èåŠ›åº¦:</strong> <span id="aiRecommendation">-</span>
                </div>
            </div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>ğŸ¯ æ¸¸æˆç»“æŸ!</h2>
            <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
            <button onclick="resetGame()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const GRAVITY = 0.75;
        const VX_MULTIPLIER = 0.10;
        const VY_MULTIPLIER = -0.25;
        const PLAYER_SIZE = 20;
        const PLATFORM_HEIGHT = 20;
        const PLATFORM_WIDTH = 100;

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            player: { x: 100, y: 300, vx: 0, vy: 0, isJumping: false },
            platforms: [],
            currentPlatformIndex: 0,
            score: 0,
            gameOver: false
        };

        // Canvas è®¾ç½®
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // UI å…ƒç´ 
        const powerInput = document.getElementById('powerInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const jumpBtn = document.getElementById('jumpBtn');
        const aiJumpBtn = document.getElementById('aiJumpBtn');
        const resetBtn = document.getElementById('resetBtn');

        // AI Agent é…ç½®
        const PYTHON_API_URL = 'http://localhost:5000/api';
        let isAiEnabled = false;
        let apiKeySet = false;

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameState = {
                player: { x: 100, y: 300, vx: 0, vy: 0, isJumping: false },
                platforms: [],
                currentPlatformIndex: 0,
                score: 0,
                gameOver: false
            };

            // åˆ›å»ºåˆå§‹å¹³å°
            createInitialPlatforms();
            updateUI();
            render();
        }

        // åˆ›å»ºåˆå§‹å¹³å°
        function createInitialPlatforms() {
            // èµ·å§‹å¹³å°
            gameState.platforms.push({
                x: 50,
                y: 320,
                width: PLATFORM_WIDTH,
                height: PLATFORM_HEIGHT
            });

            // ç›®æ ‡å¹³å°
            generateNextPlatform();
        }

        // ç”Ÿæˆä¸‹ä¸€ä¸ªå¹³å°
        function generateNextPlatform() {
            const lastPlatform = gameState.platforms[gameState.platforms.length - 1];
            const minDistance = 80;
            const maxDistance = 200;
            const distance = minDistance + Math.random() * (maxDistance - minDistance);
            
            const newPlatform = {
                x: lastPlatform.x + distance,
                y: 280 + Math.random() * 80, // éšæœºé«˜åº¦
                width: PLATFORM_WIDTH,
                height: PLATFORM_HEIGHT
            };

            gameState.platforms.push(newPlatform);
        }

        // AI Agent å‡½æ•°
        async function setApiKey() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('è¯·å…ˆè¾“å…¥Gemini API Keyï¼');
                return false;
            }

            try {
                document.getElementById('aiStatus').textContent = 'è®¾ç½®API Keyä¸­...';
                
                const response = await fetch(`${PYTHON_API_URL}/set_api_key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });

                if (!response.ok) {
                    throw new Error(`è®¾ç½®å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.status === 'success') {
                    apiKeySet = true;
                    document.getElementById('aiStatus').textContent = 'å°±ç»ª';
                    return true;
                } else {
                    throw new Error(data.error || 'è®¾ç½®API Keyå¤±è´¥');
                }
                
            } catch (error) {
                console.error('è®¾ç½®API Keyå¤±è´¥:', error);
                document.getElementById('aiStatus').textContent = 'é”™è¯¯: ' + error.message;
                alert('è®¾ç½®API Keyå¤±è´¥: ' + error.message);
                return false;
            }
        }

        async function getAiRecommendation() {
            const player = gameState.player;
            const targetPlatform = gameState.platforms[gameState.currentPlatformIndex + 1];
            
            if (!targetPlatform) return null;

            // æ£€æŸ¥åç«¯è¿æ¥
            try {
                await fetch(`${PYTHON_API_URL}/health`);
            } catch (error) {
                alert('æ— æ³•è¿æ¥åˆ°AIæœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿Pythonåç«¯å·²å¯åŠ¨ï¼\nè¿è¡Œå‘½ä»¤: python ai_agent.py');
                return null;
            }

            // å¦‚æœè¿˜æ²¡è®¾ç½®API Keyï¼Œå…ˆè®¾ç½®
            if (!apiKeySet) {
                const success = await setApiKey();
                if (!success) return null;
            }

            try {
                document.getElementById('aiStatus').textContent = 'è®¡ç®—ä¸­...';
                
                const requestData = {
                    player_pos: [Math.round(player.x), Math.round(player.y)],
                    target_platform: [
                        Math.round(targetPlatform.x), 
                        Math.round(targetPlatform.y), 
                        Math.round(targetPlatform.x + targetPlatform.width)
                    ],
                    physics_params: [VX_MULTIPLIER, VY_MULTIPLIER, GRAVITY]
                };

                const response = await fetch(`${PYTHON_API_URL}/get_recommendation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.status === 'success') {
                    const recommendedPower = data.recommended_power;
                    const usingAi = data.using_ai;
                    
                    document.getElementById('aiStatus').textContent = usingAi ? 'å°±ç»ª (AI)' : 'å°±ç»ª (ç‰©ç†è®¡ç®—)';
                    document.getElementById('aiRecommendation').textContent = recommendedPower;
                    return recommendedPower;
                } else {
                    throw new Error(data.error || 'AIæ¨èå¤±è´¥');
                }
                
            } catch (error) {
                console.error('AIæ¨èå¤±è´¥:', error);
                document.getElementById('aiStatus').textContent = 'é”™è¯¯: ' + error.message;
                document.getElementById('aiRecommendation').textContent = '-';
                alert('AIæ¨èå¤±è´¥: ' + error.message);
                return null;
            }
        }

        // AIè‡ªåŠ¨è·³è·ƒ
        async function aiJump() {
            if (gameState.player.isJumping || gameState.gameOver) return;

            const recommendedPower = await getAiRecommendation();
            if (recommendedPower !== null) {
                powerInput.value = recommendedPower;
                
                // å»¶è¿Ÿä¸€ç§’è®©ç”¨æˆ·çœ‹åˆ°æ¨èå€¼ï¼Œç„¶åè‡ªåŠ¨è·³è·ƒ
                setTimeout(() => {
                    jump();
                }, 1000);
            }
        }

        // æ£€æŸ¥API KeyçŠ¶æ€
        function checkApiKeyStatus() {
            const hasApiKey = apiKeyInput.value.trim().length > 0;
            aiJumpBtn.disabled = !hasApiKey || gameState.player.isJumping || gameState.gameOver;
            
            if (hasApiKey && !gameState.gameOver) {
                if (!apiKeySet) {
                    document.getElementById('aiStatus').textContent = 'éœ€è¦è®¾ç½®API Key';
                }
                isAiEnabled = true;
            } else if (!hasApiKey) {
                document.getElementById('aiStatus').textContent = 'æœªå¯ç”¨';
                document.getElementById('aiRecommendation').textContent = '-';
                isAiEnabled = false;
                apiKeySet = false;
            }
        }
        function jump() {
            if (gameState.player.isJumping || gameState.gameOver) return;

            const power = parseInt(powerInput.value) || 0;
            if (power < 0 || power > 100) {
                alert('è·³è·ƒåŠ›åº¦å¿…é¡»åœ¨0-100ä¹‹é—´ï¼');
                return;
            }

            gameState.player.vx = power * VX_MULTIPLIER;
            gameState.player.vy = power * VY_MULTIPLIER;
            gameState.player.isJumping = true;

            jumpBtn.disabled = true;
            aiJumpBtn.disabled = true;
            updateUI();
            animateJump();
        }

        // è·³è·ƒåŠ¨ç”»
        function animateJump() {
            if (!gameState.player.isJumping) return;

            // æ›´æ–°ä½ç½®
            gameState.player.x += gameState.player.vx;
            gameState.player.y += gameState.player.vy;

            // åº”ç”¨é‡åŠ›
            gameState.player.vy += GRAVITY;

            // æ£€æŸ¥ç¢°æ’ï¼ˆä»…åœ¨ä¸‹è½è¿‡ç¨‹ä¸­ï¼‰
            if (gameState.player.vy > 0) {
                checkCollision();
            }

            // æ£€æŸ¥æ˜¯å¦æ‰å‡ºå±å¹•
            if (gameState.player.y > canvas.height + 50) {
                endGame();
                return;
            }

            render();
            updateUI();

            if (gameState.player.isJumping) {
                requestAnimationFrame(animateJump);
            }
        }

        // ç¢°æ’æ£€æµ‹
        function checkCollision() {
            const player = gameState.player;
            const targetPlatform = gameState.platforms[gameState.currentPlatformIndex + 1];

            if (!targetPlatform) return;

            // çŸ©å½¢ç¢°æ’æ£€æµ‹
            const playerLeft = player.x - PLAYER_SIZE / 2;
            const playerRight = player.x + PLAYER_SIZE / 2;
            const playerTop = player.y - PLAYER_SIZE / 2;
            const playerBottom = player.y + PLAYER_SIZE / 2;

            const platformLeft = targetPlatform.x;
            const platformRight = targetPlatform.x + targetPlatform.width;
            const platformTop = targetPlatform.y;
            const platformBottom = targetPlatform.y + targetPlatform.height;

            // æ£€æŸ¥çŸ©å½¢é‡å 
            if (playerRight >= platformLeft && playerLeft <= platformRight &&
                playerBottom >= platformTop && playerTop <= platformBottom) {
                
                // ç²¾ç»†åˆ¤å®š
                const verticalDistance = Math.abs(playerBottom - platformTop);
                const horizontalInBounds = player.x >= platformLeft && player.x <= platformRight;

                // å‚ç›´æ¥è¿‘åˆ¤å®šï¼ˆè·ç¦»å°äº10åƒç´ ï¼‰å’Œæ°´å¹³è½ç‚¹åˆ¤å®š
                if (verticalDistance <= 10 && horizontalInBounds) {
                    landOnPlatform(targetPlatform);
                }
            }
        }

        // æˆåŠŸç€é™†
        function landOnPlatform(platform) {
            gameState.player.y = platform.y - PLAYER_SIZE / 2;
            gameState.player.vx = 0;
            gameState.player.vy = 0;
            gameState.player.isJumping = false;
            gameState.currentPlatformIndex++;
            gameState.score += 10;

            // ç”Ÿæˆæ–°å¹³å°
            generateNextPlatform();

            // é‡æ–°å¯ç”¨è·³è·ƒæŒ‰é’®
            jumpBtn.disabled = false;
            checkApiKeyStatus(); // æ£€æŸ¥AIæŒ‰é’®çŠ¶æ€
            updateUI();

            // ç§»åŠ¨ç›¸æœºï¼ˆæ»šåŠ¨æ•ˆæœï¼‰
            if (gameState.player.x > canvas.width / 2) {
                const offset = gameState.player.x - canvas.width / 2;
                gameState.player.x = canvas.width / 2;
                gameState.platforms.forEach(p => p.x -= offset);
            }
        }

        // æ¸¸æˆç»“æŸ
        function endGame() {
            gameState.gameOver = true;
            gameState.player.isJumping = false;
            jumpBtn.disabled = true;
            
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalScore').textContent = gameState.score;
            updateUI();
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            document.getElementById('gameOver').style.display = 'none';
            jumpBtn.disabled = false;
            checkApiKeyStatus(); // æ£€æŸ¥AIæŒ‰é’®çŠ¶æ€
            initGame();
        }

        // æ¸²æŸ“æ¸¸æˆ
        function render() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶å¹³å°
            ctx.fillStyle = '#8B4513';
            gameState.platforms.forEach((platform, index) => {
                // å½“å‰å¹³å°ç”¨ä¸åŒé¢œè‰²æ ‡è¯†
                if (index === gameState.currentPlatformIndex + 1) {
                    ctx.fillStyle = '#FFD700'; // ç›®æ ‡å¹³å°ç”¨é‡‘è‰²
                } else if (index === gameState.currentPlatformIndex) {
                    ctx.fillStyle = '#32CD32'; // å½“å‰å¹³å°ç”¨ç»¿è‰²
                } else {
                    ctx.fillStyle = '#8B4513'; // å…¶ä»–å¹³å°ç”¨æ£•è‰²
                }
                
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                // ç»˜åˆ¶å¹³å°è¾¹æ¡†
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            });

            // ç»˜åˆ¶ç©å®¶
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.arc(gameState.player.x, gameState.player.y, PLAYER_SIZE / 2, 0, Math.PI * 2);
            ctx.fill();
            
            // ç©å®¶è¾¹æ¡†
            ctx.strokeStyle = '#C0392B';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ç»˜åˆ¶è½¨è¿¹çº¿ï¼ˆå¦‚æœæ­£åœ¨è·³è·ƒï¼‰
            if (gameState.player.isJumping) {
                ctx.strokeStyle = 'rgba(255, 107, 107, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(gameState.player.x - gameState.player.vx * 5, gameState.player.y - gameState.player.vy * 5);
                ctx.lineTo(gameState.player.x, gameState.player.y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            const player = gameState.player;
            const targetPlatform = gameState.platforms[gameState.currentPlatformIndex + 1];

            document.getElementById('score').textContent = gameState.score;
            document.getElementById('playerPos').textContent = `(${Math.round(player.x)}, ${Math.round(player.y)})`;
            
            if (targetPlatform) {
                const platformInfo = `(${Math.round(targetPlatform.x)}, ${Math.round(targetPlatform.y)}, ${Math.round(targetPlatform.x + targetPlatform.width)})`;
                document.getElementById('platformInfo').textContent = platformInfo;
            }

            document.getElementById('vxMul').textContent = VX_MULTIPLIER;
            document.getElementById('vyMul').textContent = VY_MULTIPLIER;
            document.getElementById('gravity').textContent = GRAVITY;

            let status = 'å‡†å¤‡è·³è·ƒ';
            if (gameState.player.isJumping) {
                status = 'è·³è·ƒä¸­...';
            } else if (gameState.gameOver) {
                status = 'æ¸¸æˆç»“æŸ';
            }
            document.getElementById('gameStatus').textContent = status;
        }

        // äº‹ä»¶ç›‘å¬å™¨
        jumpBtn.addEventListener('click', jump);
        aiJumpBtn.addEventListener('click', aiJump);
        resetBtn.addEventListener('click', resetGame);
        apiKeyInput.addEventListener('input', checkApiKeyStatus);

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                jump();
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
        checkApiKeyStatus();
    </script>
</body>
</html>
